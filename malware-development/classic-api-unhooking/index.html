<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Classic API Unhooking | Script Adults</title>
<meta name="keywords" content="windows, PE, C&#43;&#43;">
<meta name="description" content="Introduction AV and EDR use API hoooking to monitor API calls of processes. This post will take a brief look on how does a hook look like and the classic solution for malwares to bypass API hooking.
I tested the content of this blog in a windows 10 VM with BitDefender installed.
You can get the sample code here.
API hooking On the Windows VM with BitDefender installed, if you load a PE into x64dbg and look for NtMapViewOfSection, you will see the first instruction is jmp to something.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/malware-development/classic-api-unhooking/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/malware-development/classic-api-unhooking/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="Script Adults (Alt + H)">Script Adults</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/" title="Research">
                    <span>Research</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/malware-development/">Malware Developments</a></div>
    <h1 class="post-title entry-hint-parent">
      Classic API Unhooking
    </h1>
    <div class="post-meta"><span title='2022-04-14 20:54:39 +0800 CST'>April 14, 2022</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#introduction" aria-label="Introduction">Introduction</a></li>
                <li>
                    <a href="#api-hooking" aria-label="API hooking">API hooking</a></li>
                <li>
                    <a href="#creating-a-view-of-a-fresh-copy-of-ntdlldll" aria-label="Creating a view of a fresh copy of ntdll.dll">Creating a view of a fresh copy of ntdll.dll</a></li>
                <li>
                    <a href="#rewrite-the-text-section" aria-label="Rewrite the .text section">Rewrite the .text section</a></li>
                <li>
                    <a href="#ntdlldll-unhooked" aria-label="Ntdll.dll unhooked">Ntdll.dll unhooked</a></li>
                <li>
                    <a href="#afterword" aria-label="Afterword">Afterword</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>AV and EDR use API hoooking to monitor API calls of processes. This post will take a brief look on how does a hook look like and the classic solution for malwares to bypass API hooking.</p>
<p>I tested the content of this blog in a windows 10 VM with BitDefender installed.</p>
<p>You can get the sample code <a href="https://github.com/KatsuragiCSL/classic-unhooking">here</a>.</p>
<h2 id="api-hooking">API hooking<a hidden class="anchor" aria-hidden="true" href="#api-hooking">#</a></h2>
<p><img loading="lazy" src="/classic-api-unhooking/s1.png" alt=""  />
</p>
<p><img loading="lazy" src="/classic-api-unhooking/s2.png" alt=""  />
</p>
<p>On the Windows VM with BitDefender installed, if you load a PE into x64dbg and look for <code>NtMapViewOfSection</code>, you will see the first instruction is jmp to something.<br>
This is NOT how <code>ZwMapViewOfSection</code> looks like originally, but an inline hook on this function by BitDefender.</p>
<p>BitDefender set the hook in order to perform its job before the function runs. In order to evade from BitDefender, you need to evade from this hook. The method discussed in this post is known as classic unhooking.</p>
<h2 id="creating-a-view-of-a-fresh-copy-of-ntdlldll">Creating a view of a fresh copy of ntdll.dll<a hidden class="anchor" aria-hidden="true" href="#creating-a-view-of-a-fresh-copy-of-ntdlldll">#</a></h2>
<p><img loading="lazy" src="/classic-api-unhooking/1.png" alt=""  />
</p>
<p>This is the part responsible for creating a view of the fresh copy of ntdll.dll on disk.</p>
<p>We also need a handle of ntdll.dll which loaded into the current process. It is the one which (some of) its functions are hooked. Let&rsquo;s call it <code>pollutedNtdll</code>.</p>
<h2 id="rewrite-the-text-section">Rewrite the .text section<a hidden class="anchor" aria-hidden="true" href="#rewrite-the-text-section">#</a></h2>
<p><img loading="lazy" src="/classic-api-unhooking/2.png" alt=""  />
</p>
<p>These few lines are for getting to the section header (and number of sections for iteration). If you are not familiar with PE structure, you could take a look at <a href="https://github.com/corkami/pics/tree/master/binary/pe101">PE101</a> which has nice pictures. You may also want to refer to MSDN pages like <a href="https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_nt_headers64">this</a>.</p>
<p>We also defined a <code>DWORD</code> variable <code>oldprotect</code> for saving the <a href="https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotect">old access protection value</a>.</p>
<p><img loading="lazy" src="/classic-api-unhooking/3.png" alt=""  />
</p>
<p>You can get the number of sections in a PE file in the <code>IMAGE_FILE_HEADER</code> structure. We iterate through the sections and find the <code>.text</code> section.<br>
If we get it, we make the <code>.text</code> section of pollutedNtdll writable, by <code>VirtualProtect</code>.</p>
<p><img loading="lazy" src="/classic-api-unhooking/4.png" alt=""  />
</p>
<p>Now we can copy the <code>.text</code> section from the fresh copy of <code>ntdll.dll</code> to the one polluted.</p>
<p><img loading="lazy" src="/classic-api-unhooking/5.png" alt=""  />
</p>
<p>Finally make sure we recover the access protection.</p>
<h2 id="ntdlldll-unhooked">Ntdll.dll unhooked<a hidden class="anchor" aria-hidden="true" href="#ntdlldll-unhooked">#</a></h2>
<p>Now we set a breakpoint on an instruction after the unhooking (in this case it is where &ldquo;done!&rdquo; is printed).<br>
Run it and the breakpoint is hit:</p>
<p><img loading="lazy" src="/classic-api-unhooking/s3.png" alt=""  />
</p>
<p>Back to the address of <code>ZwMapViewOfSection</code>, you can see the hook is gone.</p>
<p><img loading="lazy" src="/classic-api-unhooking/s4.png" alt=""  />
</p>
<h2 id="afterword">Afterword<a hidden class="anchor" aria-hidden="true" href="#afterword">#</a></h2>
<p>First of all, as a simple sample, I did not put any effort in obfuscating my function calls/ strings etc. So the code is definitely far from ready-to-go.<br>
There will probably be posts about basic obfuscation in the future.</p>
<p>And, is it a perfect solution for API unhooking? Of course not, as it&rsquo;s called <strong>Classic</strong> unhooking :)<br>
In fact, there is a part looks suspicious when we unhooking like this, as in the EDR&rsquo;s point of view:</p>
<blockquote>
<p>Why the heck is this process reading <code>ntdll.dll</code> from disk???<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup></p>
</blockquote>
<p>Yes, normal process should not read <code>ntdll.dll</code> &ldquo;manually&rdquo;, as it should be automatically loaded. There will be posts about more advanced technique for unhooking in the future.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://www.cyberbit.com/blog/endpoint-security/malware-mitigation-when-direct-system-calls-are-used/">https://www.cyberbit.com/blog/endpoint-security/malware-mitigation-when-direct-system-calls-are-used/</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/windows/">Windows</a></li>
      <li><a href="http://localhost:1313/tags/pe/">PE</a></li>
      <li><a href="http://localhost:1313/tags/c&#43;&#43;/">C&#43;&#43;</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="http://localhost:1313/">Script Adults</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
